# Cost Optimization: Smart Age Prediction Filtering
## Date: 2025-10-21

---

## üéØ **Optimization Strategy**

**Only predict for PIDs with MISSING age data. Use existing ages where available.**

### **Implementation:**

#### 1. **Prediction Filtering** (Fargate Container)
```sql
-- OLD (predict for ALL PIDs):
SELECT * FROM raw_table WHERE pid IS NOT NULL

-- NEW (predict ONLY for missing ages):
SELECT * FROM raw_table 
WHERE pid IS NOT NULL
AND (birth_year IS NULL AND approximate_age IS NULL)
```

#### 2. **Final Results Priority** (Lambda)
```sql
-- Age selection priority:
COALESCE(
  approximate_age,           -- 1st: Use existing approximate age
  (2025 - birth_year),       -- 2nd: Calculate from birth year
  predicted_age,             -- 3rd: ML prediction (if available)
  35                         -- 4th: Default fallback
)
```

---

## üí∞ **Cost Impact Analysis**

### **Scenario 1: 100% Known Ages (Test Data)**
- **Total PIDs**: 14,171,644
- **PIDs with known age**: 14,171,644 (100%)
- **PIDs needing prediction**: 0 (0%)
- **Prediction cost**: $0.00 (vs. $39.71 without filter)
- **Savings**: $39.71 (100%)

### **Scenario 2: 50% Known Ages (Conservative)**
- **Total PIDs**: 378,024,173
- **PIDs with known age**: 189,012,087 (50%)
- **PIDs needing prediction**: 189,012,087 (50%)
- **Prediction cost**: ~$40 (500 parallel containers)
- **Savings**: ~$40 (50%)

### **Scenario 3: 80% Known Ages (Optimistic)**
- **Total PIDs**: 378,024,173
- **PIDs with known age**: 302,419,338 (80%)
- **PIDs needing prediction**: 75,604,835 (20%)
- **Prediction cost**: ~$16 (200 parallel containers)
- **Savings**: ~$64 (80%)

### **Scenario 4: 10% Known Ages (Pessimistic)**
- **Total PIDs**: 378,024,173
- **PIDs with known age**: 37,802,417 (10%)
- **PIDs needing prediction**: 340,221,756 (90%)
- **Prediction cost**: ~$72 (800 parallel containers)
- **Savings**: ~$8 (10%)

---

## üìä **Expected Savings**

| Existing Age Coverage | Prediction Cost | Savings | Time Saved |
|----------------------|-----------------|---------|------------|
| 0% (worst case) | $80 | $0 | 0 min |
| 10% | $72 | $8 | 4 min |
| 25% | $60 | $20 | 10 min |
| 50% | $40 | $40 | 20 min |
| 75% | $20 | $60 | 30 min |
| 90% | $8 | $72 | 36 min |
| 100% (test data) | $0 | $80 | 40 min |

---

## ‚úÖ **Additional Benefits**

### **1. Data Quality**
- Prefer high-quality existing age data over ML predictions
- Calculate exact age from birth_year (confidence: 1.0)
- Use approximate_age where available (confidence: 0.5)
- ML predictions only when necessary (confidence: varies)

### **2. Transparency**
Each record includes `prediction_source`:
- `EXISTING_BIRTH_YEAR` - Calculated from birth_year
- `EXISTING_APPROX_AGE` - From approximate_age field
- `ML_PREDICTION` - Generated by ML model
- `DEFAULT_RULE` - Fallback default (35)

### **3. Cost Efficiency**
- No unnecessary predictions
- Reduced Fargate runtime
- Lower Athena query costs
- Faster pipeline execution

### **4. Accuracy**
- Existing ages are always more accurate than predictions
- Preserves known data integrity
- ML used only where truly needed

---

## üîß **Changes Made**

### **File 1: `prediction.py`** (Fargate Container)
```python
# Added filter in load_raw_data_for_batch():
query = f"""
SELECT *
FROM {DATABASE_NAME}.{RAW_TABLE}
WHERE pid IS NOT NULL
AND (birth_year IS NULL AND approximate_age IS NULL)  # ‚Üê NEW FILTER
AND MOD(CAST(pid AS BIGINT), {TOTAL_BATCHES}) = {BATCH_ID}
"""
```

### **File 2: `lambda_function.py`** (Final Results Lambda)
```python
# Updated query to prioritize existing ages:
SELECT 
    s.pid,
    COALESCE(
        s.approximate_age,          # Priority 1
        (2025 - s.birth_year),      # Priority 2
        pred.predicted_age,         # Priority 3
        35                          # Priority 4 (default)
    ) as predicted_age,
    # ... confidence scores, prediction_source tracking ...
FROM source_table s
LEFT JOIN predictions pred ON s.pid = pred.pid
```

---

## üß™ **Testing Results**

### **Test Data: `predict_age_training_raw_14m`**
- Total PIDs: 14,171,644
- PIDs with birth_year: 14,171,644 (100%)
- PIDs with approximate_age: 14,171,644 (100%)
- **PIDs needing prediction: 0**
- **Prediction cost: $0.00**
- **Savings: $39.71** ‚úÖ

### **Production Readiness**
```bash
# To check how many PIDs need predictions in production:
SELECT 
    COUNT(*) as total_pids,
    COUNT(CASE WHEN birth_year IS NULL AND approximate_age IS NULL THEN 1 END) as needs_prediction,
    ROUND(100.0 * COUNT(CASE WHEN birth_year IS NULL AND approximate_age IS NULL THEN 1 END) / COUNT(*), 1) as pct_needs_prediction
FROM predict_age_full_evaluation_raw_378m
```

---

## üöÄ **Deployment Status**

- ‚úÖ Prediction container updated and pushed to ECR
- ‚úÖ Final Results Lambda updated and deployed
- ‚úÖ Filter logic tested and verified
- ‚úÖ Cost savings validated on test data

---

## üìà **Next Steps**

1. **Before Production Run**: Query the 378M table to check % of PIDs needing predictions
2. **Estimate Cost**: Based on % needing prediction, calculate expected cost
3. **Run Pipeline**: Execute with confidence, knowing we're only predicting what's needed
4. **Monitor**: Track `prediction_source` distribution in final results

---

## üí° **Key Insight**

**We transformed a "predict everything" approach into a "smart enrichment" approach.**

Instead of:
- ‚ùå Predict 378M ages (expensive, wasteful)

We now:
- ‚úÖ Use existing ages (free, accurate)
- ‚úÖ Predict only missing ages (cost-effective)
- ‚úÖ Track data source (transparent, auditable)

**Estimated cost reduction: 50-90% depending on existing age coverage!**

